#!/usr/bin/env Rscript

# Read in the fgsea package
library(fgsea)

# Get command line arguments
args <- commandArgs(trailingOnly = TRUE)
top_table <- args[1]
db <- args[2]

if (!file.exists(top_table)) stop("toptable file does not exist")
if (!file.exists(db)) stop("db file does not exist")

# Read in the top table generated by limma-voom differential expression
top <- read.csv(top_table, row.names=1)

# Load the database
load(db)

# create a named vector of the differentially expressed genes
stats <- top$t
names(stats) <- rownames(top)

# Provide a gene set summary that counts up the number of receptor genes that characterize one ligand
length_receptors <- sapply(cellchat_mouse_LRI, length)

# Perform gene set enrichment analysis leveraging the LRI database
# minSize and maxSize can be adjusted accordingly. I just set according to the database min and max number of
# receptors that characterize one ligand. 
fgsea_results <- fgsea(pathways = cellchat_mouse_LRI, stats = stats, minSize = min(length_receptors), maxSize = max(length_receptors))

# Order the pathway enrichment by adjusted pvalue
fgsea_results <- fgsea_results[order(padj), ]

# output the final result from pathway analysis which shows 
# the activity of a ligand represented by differentially expressed receptor genes
# based on the CellChatDBv2 LRI list
data.table::fwrite(fgsea_results, file="fgsea_ligand_activity.txt", sep="\t", sep2=c("", " ", "")) 